name: Build âš™ and Deploy ðŸš€

on: [push, pull_request]

concurrency:
    group: ${{ github.ref }}

jobs:
    build_and_deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout ðŸšš
              uses: actions/checkout@v4

            - name: Setup pnpm âš—
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Setup Node.js âš—
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: pnpm

            - name: Install dependencies ðŸŒ
              run: pnpm install --frozen-lockfile

            - name: Lint
              if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev'
              run: pnpm run pretty:check

            - name: Build ðŸ› 
              if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev'
              run: pnpm run build

            - name: Run tests ðŸ©º
              run: pnpm run test

            - name: Add build.txt ðŸ—“
              if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev'
              run: |
                  git log --pretty=format:'%h' -n 1 > dist/build.txt
                  echo >> dist/build.txt
                  date +%F_%T >> dist/build.txt

            - name: Deploy ðŸš€
              if: github.ref == 'refs/heads/master'
              uses: JamesIves/github-pages-deploy-action@v4.6.4
              with:
                  branch: gh-pages # The branch the action should deploy to.
                  folder: dist # The folder the action should deploy.
                  single-commit: true
                  clean: true
